<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shared Marble Jar</title>
<style>
  body { 
    font-family: sans-serif; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    background: #f0f0f0; 
    margin:0; 
    padding:0;
  }
  canvas { border:2px solid #444; border-radius:12px; background:#fff; margin-top:20px; }
  #controls { margin-top: 20px; }
  button { margin:5px; padding:10px 15px; font-size:16px; }
</style>
</head>
<body>

<h2>Shared Marble Jar</h2>
<canvas id="jarCanvas" width="500" height="600"></canvas>

<div id="controls">
  <button onclick="addMarblePrompt()">Add Marble(s)</button>
  <button onclick="removeMarblePrompt()">Remove Marble(s)</button>
  <button onclick="resetJar()">Reset Jar</button>
  <button onclick="teacherLogin()">Teacher Login</button>
</div>

<p>Total Marbles: <span id="count">0</span></p>

<script>
const canvas = document.getElementById("jarCanvas");
const ctx = canvas.getContext("2d");

const BIN_ID = "693a03a3ae596e708f9126c0";
const API_KEY = "$2a$10$0rZ/Uu8tUG56P9.a7m1nHu21gNVTdlPYXrNYbwMEM5mIoudpjmfEi";

let marbles = [];
let marbleCount = 0;
let isTeacher = false;

// Gravity and physics settings
const gravity = 0.5;
const bounce = -0.7;

// Marble class
class Marble {
  constructor() {
    this.radius = 15 + Math.random()*5;
    this.x = 100 + Math.random()*300;
    this.y = 50;
    this.vx = Math.random()*4-2;
    this.vy = 0;
    this.color = ["red","blue","green","yellow","purple"][Math.floor(Math.random()*5)];
  }
  update() {
    this.vy += gravity;
    this.x += this.vx;
    this.y += this.vy;

    // collision with jar bottom
    if(this.y + this.radius > 550) {
      this.y = 550 - this.radius;
      this.vy *= bounce;
      this.vx *= 0.9;
    }
    // collision with jar sides
    if(this.x - this.radius < 50) { this.x = 50 + this.radius; this.vx *= bounce; }
    if(this.x + this.radius > 450) { this.x = 450 - this.radius; this.vx *= bounce; }
  }
  draw() {
    const grad = ctx.createRadialGradient(this.x-3,this.y-3,this.radius/5,this.x,this.y,this.radius);
    grad.addColorStop(0,this.color);
    grad.addColorStop(1,"#555");
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fillStyle = grad;
    ctx.fill();
  }
}

// Draw jar
function drawJar() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#ddd";
  ctx.fillRect(50,50,400,500); // jar
  marbles.forEach(m => { m.update(); m.draw(); });
}

// Update count display
function updateCount() {
  document.getElementById("count").innerText = marbleCount;
}

// Load count from JSONBin
async function loadMarbles() {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    const data = await res.json();
    marbleCount = data.record.marbles || 0;
    marbles = [];
    for(let i=0;i<marbleCount;i++) marbles.push(new Marble());
    updateCount();
  } catch(e) { console.error("Failed to load marbles:", e); }
}

// Save count to JSONBin
async function saveMarbles() {
  try {
    await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify({marbles: marbleCount})
    });
  } catch(e) { console.error("Failed to save marbles:", e); }
}

// Add/Remove/Reset
async function addMarbles(n) {
  if(!isTeacher) { alert("Teacher login required!"); return; }
  for(let i=0;i<n;i++) marbles.push(new Marble());
  marbleCount += n;
  updateCount();
  await saveMarbles();
}

async function removeMarbles(n) {
  if(!isTeacher) { alert("Teacher login required!"); return; }
  n = Math.min(n, marbleCount);
  marbles.splice(0,n);
  marbleCount -= n;
  updateCount();
  await saveMarbles();
}

async function resetJar() {
  if(!isTeacher) { alert("Teacher login required!"); return; }
  if(confirm("Are you sure you want to reset the jar?")) {
    marbles = [];
    marbleCount = 0;
    updateCount();
    await saveMarbles();
  }
}

// Prompt wrappers
function addMarblePrompt() {
  const n = parseInt(prompt("How many marbles to add?", "1"));
  if(!isNaN(n) && n>0) addMarbles(n);
}

function removeMarblePrompt() {
  const n = parseInt(prompt("How many marbles to remove?", "1"));
  if(!isNaN(n) && n>0) removeMarbles(n);
}

// Teacher login
function teacherLogin() {
  const pw = prompt("Enter teacher password:");
  if(pw==="openup123") {
    isTeacher = true;
    alert("Teacher access granted!");
  } else {
    alert("Wrong password");
  }
}

// Animation loop
function animate() {
  drawJar();
  requestAnimationFrame(animate);
}

// Initialize
loadMarbles();
animate();
</script>

</body>
</html>
