<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Shared Marble Jar</title>
<style>
  body { 
    font-family: sans-serif; 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    background: #f0f0f0; 
    margin:0; 
    padding:0;
  }
  canvas { border:2px solid #444; border-radius:12px; background:#fff; margin-top:20px; }
  #controls { margin-top: 20px; }
  button { margin:5px; padding:10px 15px; font-size:16px; }
</style>
</head>
<body>

<h2>Shared Marble Jar</h2>
<canvas id="jarCanvas" width="500" height="600"></canvas>

<div id="controls">
  <button onclick="addMarblePrompt()">Add Marble(s)</button>
  <button onclick="removeMarblePrompt()">Remove Marble(s)</button>
  <button onclick="resetJar()">Reset Jar</button>
  <button onclick="teacherLogin()">Teacher Login</button>
</div>

<p>Total Marbles: <span id="count">0</span></p>

<script>
const canvas = document.getElementById("jarCanvas");
const ctx = canvas.getContext("2d");
let marbles = [];
let isTeacher = false;

// JSONBin.io config
const BIN_ID = "693a03a3ae596e708f9126c0";
const API_KEY = "$2a$10$0rZ/Uu8tUG56P9.a7m1nHu21gNVTdlPYXrNYbwMEM5mIoudpjmfEi";
const STORAGE_KEY = "marbleJar_shared";

// Draw jar
function drawJar() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#ddd";
    ctx.fillRect(50,50,400,500); // jar
    marbles.forEach(m => {
        ctx.beginPath();
        ctx.arc(m.x,m.y,m.radius,0,Math.PI*2);
        const grad = ctx.createRadialGradient(m.x-3,m.y-3,m.radius/5,m.x,m.y,m.radius);
        grad.addColorStop(0,m.color);
        grad.addColorStop(1,"#555");
        ctx.fillStyle=grad;
        ctx.fill();
    });
}

// Update count display
function updateCount() {
    document.getElementById("count").innerText = marbles.length;
}

// Load from JSONBin
async function loadMarbles() {
    try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": API_KEY }
        });
        const data = await res.json();
        marbles = data.record.marbles || [];
        drawJar();
        updateCount();
    } catch(e) {
        console.error("Failed to load marbles:", e);
    }
}

// Save to JSONBin
async function saveMarbles() {
    try {
        await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY
            },
            body: JSON.stringify({marbles})
        });
    } catch(e) {
        console.error("Failed to save marbles:", e);
    }
}

// Utility: random marble
function createMarble() {
    return {
        x: 250 + (Math.random()*200-100),
        y: 500 - Math.random()*400,
        radius: 15 + Math.random()*5,
        color: ["red","blue","green","yellow","purple"][Math.floor(Math.random()*5)]
    };
}

// Add marbles
async function addMarbles(n) {
    if(!isTeacher) { alert("Teacher login required!"); return; }
    for(let i=0;i<n;i++) marbles.push(createMarble());
    drawJar();
    updateCount();
    await saveMarbles();
}

// Remove marbles
async function removeMarbles(n) {
    if(!isTeacher) { alert("Teacher login required!"); return; }
    marbles.splice(0,n);
    drawJar();
    updateCount();
    await saveMarbles();
}

// Reset jar
async function resetJar() {
    if(!isTeacher) { alert("Teacher login required!"); return; }
    if(confirm("Are you sure you want to reset the jar?")) {
        marbles = [];
        drawJar();
        updateCount();
        await saveMarbles();
    }
}

// Prompt wrappers
function addMarblePrompt() {
    const n = parseInt(prompt("How many marbles to add?", "1"));
    if(!isNaN(n) && n>0) addMarbles(n);
}
function removeMarblePrompt() {
    const n = parseInt(prompt("How many marbles to remove?", "1"));
    if(!isNaN(n) && n>0) removeMarbles(n);
}

// Teacher login
function teacherLogin() {
    const pw = prompt("Enter teacher password:");
    if(pw==="openup123") {
        isTeacher=true;
        alert("Teacher access granted!");
    } else {
        alert("Wrong password");
    }
}

// Initial load
loadMarbles();
</script>
</body>
</html>
