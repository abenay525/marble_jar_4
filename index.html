<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marble Jar â€” Teacher View</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBTvMRkuknQ4tXMHa8Bd1Dc_gMaR60hQE4",
  authDomain: "grade-marbles.firebaseapp.com",
  projectId: "grade-marbles",
  storageBucket: "grade-marbles.firebasestorage.app",
  messagingSenderId: "879432744952",
  appId: "1:879432744952:web:f874d162ba8a652f74600d"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<style>
:root{--bg:#eef2f5;--ui:#222;--btn:#2e7d32}
html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
.topbar{display:flex;gap:8px;align-items:center;padding:10px;background:transparent}
button{background:var(--btn);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
button.gray{background:#666}
#count{margin-left:auto;font-weight:700;color:var(--ui)}
#canvasWrap{display:flex;justify-content:center;padding:12px}
canvas{background:#fff;border-radius:14px;border:3px solid #444;max-width:100%;height:auto}
</style>
</head>
<body>

<div class="topbar">
  <button id="teacherLogin">Teacher Login</button>
  <button id="addBtn" disabled>Add 1</button>
  <button id="removeBtn" disabled>Remove 1</button>
  <button id="resetBtn" disabled class="gray">Reset</button>
  <div id="count">Marbles: 0</div>
</div>

<div id="canvasWrap">
  <canvas id="c" width="900" height="500"></canvas>
</div>

<script>
const TEACHER_PASSWORD = "openup123";

const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

const teacherLogin = document.getElementById("teacherLogin");
const addBtn = document.getElementById("addBtn");
const removeBtn = document.getElementById("removeBtn");
const resetBtn = document.getElementById("resetBtn");
const countEl = document.getElementById("count");

let marbles = [];
const GRAVITY = 0.2, FRICTION = 0.995, BOUNCE = 0.85;

// Teacher unlocked flag
let unlocked = false;

// Canvas resize
function resizeCanvas(){
  canvas.width = Math.min(window.innerWidth-20,1100);
  canvas.height = Math.min(window.innerHeight-140,700);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

// Firestore load
db.collection("marbleJar").doc("state").get().then(doc=>{
  if(doc.exists) marbles=doc.data().marbles||[];
});

// Firestore real-time updates
db.collection("marbleJar").doc("state").onSnapshot(doc=>{
  if(doc.exists){
    marbles = doc.data().marbles || [];
  }
});

// Save to Firestore
function saveState(){
  db.collection("marbleJar").doc("state").set({marbles});
  updateCount();
}

// Buttons
function createMarble(){
  const r = (window.innerWidth<520)?14:18;
  const x = canvas.width/2 + (Math.random()*120-60);
  const y = 30 + (Math.random()*10-5);
  const m = {x,y,vx:(Math.random()*3-1.5),vy:(Math.random()-0.5),r,color:`hsl(${Math.random()*360},70%,55%)`};
  marbles.push(m);
  saveState();
}
function removeOne(){ if(marbles.length>0){ marbles.pop(); saveState(); } }
function resetJar(){ if(!confirm("Reset jar?")) return; marbles=[]; saveState(); }

addBtn.addEventListener('click',()=>{ if(unlocked) createMarble(); });
removeBtn.addEventListener('click',()=>{ if(unlocked) removeOne(); });
resetBtn.addEventListener('click',()=>{ if(unlocked) resetJar(); });

// Teacher login
teacherLogin.addEventListener('click',()=>{
  const pw = prompt("Enter teacher password:");
  if(pw===TEACHER_PASSWORD){
    unlocked=true;
    addBtn.disabled=false;
    removeBtn.disabled=false;
    resetBtn.disabled=false;
    alert("Teacher unlocked!");
  } else alert("Incorrect password.");
});

// Physics & render
function stepPhysics(){
  const W=canvas.width,H=canvas.height;
  for(let i=0;i<marbles.length;i++){
    const m=marbles[i];
    m.vy+=GRAVITY; m.vx*=FRICTION; m.vy*=FRICTION;
    m.x+=m.vx; m.y+=m.vy;

    if(m.x-m.r<0){ m.x=m.r; m.vx=-m.vx*BOUNCE; }
    if(m.x+m.r>W){ m.x=W-m.r; m.vx=-m.vx*BOUNCE; }
    if(m.y-m.r<0){ m.y=m.r; m.vy=-m.vy*BOUNCE; }
    if(m.y+m.r>H){ m.y=H-m.r; m.vy=-m.vy*BOUNCE; }

    for(let j=i+1;j<marbles.length;j++){
      const n=marbles[j], dx=n.x-m.x, dy=n.y-m.y;
      const dist=Math.hypot(dx,dy), minD=m.r+n.r;
      if(dist>0 && dist<minD){
        const overlap=minD-dist, ux=dx/dist, uy=dy/dist;
        m.x-=ux*overlap*0.5; m.y-=uy*overlap*0.5;
        n.x+=ux*overlap*0.5; n.y+=uy*overlap*0.5;
        const tvx=m.vx,tvy=m.vy; m.vx=n.vx*0.95; m.vy=n.vy*0.95; n.vx=tvx*0.95; n.vy=tvy*0.95;
      }
    }
  }
}

function drawMarble(m){
  const g = ctx.createRadialGradient(m.x-m.r*0.35,m.y-m.r*0.35,m.r*0.1,m.x,m.y,m.r);
  g.addColorStop(0,'rgba(255,255,255,0.95)');
  g.addColorStop(0.15,'rgba(255,255,255,0.6)');
  g.addColorStop(0.5,m.color);
  g.addColorStop(1,'rgba(0,0,0,0.08)');
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(m.x,m.y,m.r,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='rgba(0,0,0,0.12)'; ctx.lineWidth=1; ctx.stroke();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  stepPhysics();
  marbles.forEach(drawMarble);
  countEl.textContent=`Marbles: ${marbles.length}`;
  requestAnimationFrame(render);
}

render();
</script>
</body>
</html>
